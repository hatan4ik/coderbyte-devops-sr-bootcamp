name: Security Scanning (FAANG-Grade)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  workflow_dispatch:  # Manual trigger

env:
  SEVERITY_THRESHOLD: CRITICAL,HIGH
  FAIL_ON_SEVERITY: CRITICAL

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  security-matrix:
    name: Security Scan Matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scanner: [trivy, semgrep, gitleaks, checkov]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Cache scanner databases
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/trivy
            ~/.cache/semgrep
          key: ${{ runner.os }}-security-${{ matrix.scanner }}-${{ hashFiles('**/Dockerfile', '**/*.tf') }}
          restore-keys: |
            ${{ runner.os }}-security-${{ matrix.scanner }}-
      
      - name: Run Trivy
        if: matrix.scanner == 'trivy'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: ${{ env.SEVERITY_THRESHOLD }}
          exit-code: '0'  # Don't fail, aggregate results
          vuln-type: 'os,library'
          scanners: 'vuln,secret,config'
      
      - name: Run Semgrep SAST
        if: matrix.scanner == 'semgrep'
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/kubernetes
            p/terraform
            p/docker
          generateSarif: true
        env:
          SEMGREP_RULES: auto
      
      - name: Run Gitleaks
        if: matrix.scanner == 'gitleaks'
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true
      
      - name: Run Checkov IaC scan
        if: matrix.scanner == 'checkov'
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: terraform,kubernetes,dockerfile
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true
      
      - name: Upload SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ matrix.scanner }}-results.sarif
          category: ${{ matrix.scanner }}
        continue-on-error: true
      
      - name: Archive scan results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-${{ matrix.scanner }}
          path: |
            *-results.sarif
            *-results.json
          retention-days: 30

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: [python, javascript, go]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        if: matrix.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Python dependency scan
        if: matrix.language == 'python'
        run: |
          pip install safety pip-audit
          find . -name requirements.txt -exec safety check --file {} \; || true
          find . -name requirements.txt -exec pip-audit -r {} \; || true
      
      - name: Setup Node.js
        if: matrix.language == 'javascript'
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: JavaScript dependency scan
        if: matrix.language == 'javascript'
        run: |
          npm audit --audit-level=moderate || true
          npx snyk test --severity-threshold=high || true
      
      - name: Setup Go
        if: matrix.language == 'go'
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Go dependency scan
        if: matrix.language == 'go'
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          find . -name go.mod -execdir govulncheck ./... \; || true

  container-scan:
    name: Container Image Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker images
        run: |
          find . -name Dockerfile -exec dirname {} \; | while read dir; do
            image_name=$(basename $dir)
            docker build -t $image_name:scan $dir
          done
      
      - name: Scan with Trivy
        run: |
          docker images --format "{{.Repository}}:{{.Tag}}" | grep scan | while read image; do
            trivy image --severity ${{ env.SEVERITY_THRESHOLD }} \
              --format sarif --output trivy-container-$(echo $image | tr ':/' '-').sarif $image
          done
      
      - name: Scan with Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          docker images --format "{{.Repository}}:{{.Tag}}" | grep scan | while read image; do
            grype $image --fail-on ${{ env.FAIL_ON_SEVERITY }} || true
          done
      
      - name: Generate SBOM
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          docker images --format "{{.Repository}}:{{.Tag}}" | grep scan | while read image; do
            syft $image -o spdx-json > sbom-$(echo $image | tr ':/' '-').json
          done
      
      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v3
        with:
          name: sbom-reports
          path: sbom-*.json
          retention-days: 90

  aggregate-results:
    name: Aggregate Security Results
    runs-on: ubuntu-latest
    needs: [security-matrix, dependency-scan, container-scan]
    if: always()
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
      
      - name: Aggregate and analyze results
        run: |
          python3 << 'EOF'
          import json
          import glob
          from collections import defaultdict
          
          findings = defaultdict(list)
          
          for sarif_file in glob.glob('**/*.sarif', recursive=True):
              with open(sarif_file) as f:
                  data = json.load(f)
                  for run in data.get('runs', []):
                      for result in run.get('results', []):
                          severity = result.get('level', 'note')
                          findings[severity].append({
                              'file': sarif_file,
                              'rule': result.get('ruleId'),
                              'message': result.get('message', {}).get('text')
                          })
          
          print("=== Security Scan Summary ===")
          for severity in ['error', 'warning', 'note']:
              count = len(findings[severity])
              print(f"{severity.upper()}: {count}")
          
          critical_count = len(findings['error'])
          if critical_count > 0:
              print(f"\nâŒ Found {critical_count} critical issues")
              exit(1)
          else:
              print("\nâœ… No critical issues found")
          EOF
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const findings = JSON.parse(fs.readFileSync('security-summary.json', 'utf8'));
            
            const comment = `## ðŸ”’ Security Scan Results
            
            | Severity | Count |
            |----------|-------|
            | Critical | ${findings.critical || 0} |
            | High     | ${findings.high || 0} |
            | Medium   | ${findings.medium || 0} |
            | Low      | ${findings.low || 0} |
            
            ${findings.critical > 0 ? 'âŒ Critical issues found - review required' : 'âœ… No critical issues'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  compliance-check:
    name: Compliance Validation
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: CIS Benchmark check
        run: |
          docker run --rm -v $(pwd):/src aquasec/trivy config /src \
            --policy /src/.trivy/policy.rego || true
      
      - name: OWASP dependency check
        run: |
          docker run --rm -v $(pwd):/src owasp/dependency-check:latest \
            --scan /src --format JSON --out /src/dependency-check-report.json || true
      
      - name: License compliance
        run: |
          pip install pip-licenses
          find . -name requirements.txt -exec pip-licenses --from=classifier --format=json \; > licenses.json || true
      
      - name: Upload compliance reports
        uses: actions/upload-artifact@v3
        with:
          name: compliance-reports
          path: |
            dependency-check-report.json
            licenses.json
          retention-days: 90
